<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Butonlu Sayfa ‚Äî Firebase Senkron</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#0b1220; --accent:#00b894; --muted:#9fb0c8;
      --btn:#142235; --input:#0f1724; --border:#1b2636;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Roboto,-apple-system,Segoe UI,Arial;
      color:#e6eef8;
      background:linear-gradient(180deg,#051026 0%,var(--bg) 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      padding:20px;
    }
    .container{
      width:100%;
      max-width:720px;
      padding:18px;
      border-radius:18px;
      background:var(--card);
      box-shadow:0 12px 40px rgba(2,6,23,0.6);
    }
    .header{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:14px;
    }
    .logo{
      width:56px;height:56px;border-radius:12px;
      background:linear-gradient(180deg,rgba(255,255,255,0.03),transparent);
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,0.03);
    }
    .logo strong{color:var(--accent);}
    h1{font-size:18px;margin:0;}
    .lead{font-size:13px;color:var(--muted);margin-top:4px;}
    .buttons{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:12px;
    }
    .btn{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px;
      border-radius:12px;
      background:var(--btn);
      border:1px solid rgba(255,255,255,0.02);
      cursor:pointer;
      overflow:hidden;
      transition:transform .15s, background .15s;
    }
    .btn:hover{
      background:#162b40;
      transform:translateY(-2px);
    }
    .icon{
      width:48px;
      height:48px;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(255,255,255,0.02);
      flex-shrink:0;
      font-size:20px;
    }
    .label{
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:60%;
    }
    .sublabel{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:35%;
    }
    .editor{
      margin-top:16px;
      background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.02));
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.02);
    }
    .row{
      display:flex;
      gap:8px;
      align-items:center;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    input[type=text], select{
      flex:1;
      min-width:90px;
      padding:8px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--input);
      color:#fff;
      font-size:13px;
    }
    button.small{
      padding:8px 10px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--input);
      color:#fff;
      cursor:pointer;
    }
    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
      justify-content:space-between;
      align-items:center;
    }
    .footer{
      margin-top:12px;
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }
    .row .actions{
      display:flex;
      gap:6px;
      align-items:center;
      margin-left:auto;
      flex-shrink:0;
    }
    .row .actions button{
      padding:6px 8px;
    }
    .row .extra{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
    }
    @media(max-width:480px){
      .label{max-width:50%;}
      .sublabel{max-width:40%;}
      input[type=text],select{min-width:70px;}
    }
    .pill{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(15,23,42,0.7);
      color:var(--muted);
    }
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="container" role="application" aria-label="Butonlu Sayfa">
  <div class="header">
    <div class="logo"><strong>SB</strong></div>
    <div>
      <h1>Butonlu Sayfa</h1>
      <div class="lead">Link / Mail / Dosya ‚Äî Firebase ile t√ºm cihazlarda aynƒ±.</div>
    </div>
  </div>

  <div class="buttons" id="buttons" aria-live="polite"></div>

  <div class="editor">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <div style="font-weight:700;">Butonlarƒ± D√ºzenle</div>
      <div class="pill">Deƒüi≈üiklikler otomatik Firebase'e kaydedilir.</div>
    </div>
    <div id="edit-list"></div>
    <div class="controls">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <button id="addBtn" class="small">Buton Ekle</button>
        <button id="forceSaveBtn" class="small">Kaydƒ± Zorla</button>
        <button id="resetBtn" class="small">Varsayƒ±lana D√∂n (Sadece Bu Cihaz)</button>
      </div>
      <div style="font-size:12px;color:var(--muted);">
        T√ºm cihazlar aynƒ± Firebase verisini kullanƒ±r.
      </div>
    </div>
  </div>

  <div class="footer">GitHub Pages + Firebase Firestore senkron.</div>
</div>

<script>
// ---------- Firebase ayarƒ± ----------
const firebaseConfig = {
  apiKey: "AIzaSyC65Cce1RHW6rYA5W8ic76_-WHEUGbASHI",
  authDomain: "sbkq-60ba0.firebaseapp.com",
  projectId: "sbkq-60ba0",
  storageBucket: "sbkq-60ba0.firebasestorage.app",
  messagingSenderId: "753826053617",
  appId: "1:753826053617:web:3d2e6d31e701248a139850",
  measurementId: "G-K91Y6058BP"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
// Tek dok√ºman kullanƒ±yoruz: butonluPages/default
const DOC_REF = db.collection("butonluPages").doc("default");

// ---------- Uygulama ayarlarƒ± ----------
const LOCAL_KEY = "butonlu_firebase_cache_v1";
// dosyalar cihazda, databasede deƒüil
let fileData = {};
const DEFAULTS = [
  { id: 1, label: "Instagram", url: "https://www.instagram.com/sebukagraphic_", icon: "üì∑", type: "link" },
  { id: 2, label: "E-posta", mail: "serhatbrkkrg@gmail.com", icon: "‚úâÔ∏è", type: "mail" }
];

function escapeHtml(s){
  if(!s) return "";
  return String(s).replace(/[&<>"']/g, m=>({
    "&":"&amp;",
    "<":"&lt;",
    ">":"&gt;",
    "\"":"&quot;",
    "'":"&#39;"
  }[m]));
}
function escapeAttr(s){
  if(!s) return "";
  return String(s).replace(/"/g,"&quot;");
}

// ---- Local cache ----
function saveLocal(buttons){
  localStorage.setItem(LOCAL_KEY, JSON.stringify(buttons));
  localStorage.setItem(LOCAL_KEY+"_files", JSON.stringify(fileData));
}
function loadLocal(){
  try{
    const raw = localStorage.getItem(LOCAL_KEY);
    return raw ? JSON.parse(raw) : null;
  }catch(e){
    console.warn("local okuma hatasƒ±", e);
    return null;
  }
}
function loadFileData(){
  try{
    const raw = localStorage.getItem(LOCAL_KEY+"_files");
    if(!raw) return;
    const parsed = JSON.parse(raw);
    if(parsed && typeof parsed === "object") fileData = parsed;
  }catch(e){
    console.warn("fileData okunamadƒ±", e);
  }
}

// ---- Firebase'den okuma / yazma ----
async function loadFromFirebase(){
  try{
    const snap = await DOC_REF.get();
    if(snap.exists){
      const data = snap.data();
      if(Array.isArray(data.buttons)) return data.buttons;
    }else{
      await DOC_REF.set({buttons: DEFAULTS});
      return DEFAULTS.slice();
    }
  }catch(e){
    console.error("Firebase'den y√ºklenemedi:", e);
  }
  return DEFAULTS.slice();
}

let saveTimer = null;
function scheduleSaveToFirebase(buttons){
  saveLocal(buttons);
  clearTimeout(saveTimer);
  saveTimer = setTimeout(async ()=>{
    try{
      await DOC_REF.set({buttons: buttons});
      console.log("Firebase'e kaydedildi");
    }catch(e){
      console.error("Firebase kaydetme hatasƒ±:", e);
    }
  }, 600); // 0.6sn debounce
}

// ---------- Aray√ºz: butonlar ----------
function renderButtons(list){
  const c = document.getElementById("buttons");
  c.innerHTML = "";
  list.forEach(it=>{
    const b = document.createElement("div");
    b.className = "btn";
    b.tabIndex = 0;
    const icon = escapeHtml(it.icon || "üîó");
    const label = escapeHtml(it.label || "");
    let sub = "";
    if(it.type === "mail") sub = escapeHtml(it.mail || "E-posta");
    else if(it.type === "dosya") sub = fileData[it.id]?.name || "Dosya";
    else sub = escapeHtml(it.url || "");
    b.innerHTML =
      '<div class="icon" aria-hidden="true">'+ icon +'</div>'+
      '<div style="min-width:0;"><div class="label">'+ label +'</div>'+
      '<div class="sublabel">'+ sub +'</div></div>';
    b.addEventListener("click", ()=> openItem(it));
    b.addEventListener("keydown", e=>{ if(e.key === "Enter") openItem(it); });
    c.appendChild(b);
  });
}

function openItem(it){
  if(it.type === "mail"){
    if(!it.mail){ alert("Bu buton i√ßin e-posta adresi yok."); return; }
    window.location.href = "mailto:" + it.mail;
    return;
  }
  if(it.type === "dosya"){
    const f = fileData[it.id];
    if(!f){ alert("Bu butona dosya eklenmemi≈ü."); return; }
    const a = document.createElement("a");
    a.href = f.dataUrl;
    a.download = f.name;
    a.click();
    return;
  }
  if(it.url){
    window.open(it.url, "_blank", "noopener");
    return;
  }
  alert("Bu buton i√ßin i≈ülem tanƒ±mlƒ± deƒüil.");
}

// ---------- Editor ----------
function renderEditor(list){
  const el = document.getElementById("edit-list");
  el.innerHTML = "";
  list.forEach((it, idx)=>{
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <input data-i="${idx}" class="lbl" placeholder="Etiket" value="${escapeAttr(it.label||"")}" />
      <input data-i="${idx}" class="url" placeholder="https://..." value="${escapeAttr(it.url||"")}" />
      <select data-i="${idx}" class="typ">
        <option value="link">Link</option>
        <option value="mail">Mail</option>
        <option value="dosya">Dosya</option>
      </select>
      <input data-i="${idx}" class="icn" placeholder="ikon" value="${escapeAttr(it.icon||"üîó")}" style="width:60px" />
      <div class="extra"></div>
      <div class="actions">
        <button data-i="${idx}" class="small up" title="Yukarƒ±">‚ñ≤</button>
        <button data-i="${idx}" class="small down" title="A≈üaƒüƒ±">‚ñº</button>
        <button data-i="${idx}" class="small del" title="Sil">üóë</button>
      </div>`;
    el.appendChild(row);
  });
  el.querySelectorAll(".typ").forEach(sel=>{
    const i = +sel.dataset.i;
    sel.value = list[i].type || "link";
  });
  updateExtras(list);
  attachEditorHandlers(list);
}

function updateExtras(list){
  document.querySelectorAll(".extra").forEach(ex=>{
    ex.innerHTML = "";
    const idx = +ex.parentElement.querySelector(".lbl").dataset.i;
    const it = list[idx];
    if(it.type === "mail"){
      const mailInput = document.createElement("input");
      mailInput.type = "text";
      mailInput.placeholder = "E-posta adresi";
      mailInput.value = it.mail || "";
      mailInput.addEventListener("input", e=>{
        it.mail = e.target.value;
        scheduleSaveToFirebase(list);
        renderButtons(list);
      });
      ex.appendChild(mailInput);
    }else if(it.type === "dosya"){
      const btnFile = document.createElement("button");
      btnFile.className = "small";
      btnFile.textContent = fileData[it.id] ? "Dosya Deƒüi≈ütir" : "Dosya Y√ºkle";
      btnFile.addEventListener("click", ()=>{
        const inp = document.createElement("input");
        inp.type = "file";
        inp.accept = ".pdf,image/*,application/*";
        inp.onchange = e=>{
          const f = e.target.files[0];
          if(!f) return;
          const reader = new FileReader();
          reader.onload = ev=>{
            fileData[it.id] = { name:f.name, dataUrl:ev.target.result };
            saveLocal(list); // dosyalar sadece localde
            renderButtons(list);
            updateExtras(list);
            alert("Dosya y√ºklendi: " + f.name);
          };
          reader.readAsDataURL(f);
        };
        inp.click();
      });
      ex.appendChild(btnFile);

      if(fileData[it.id]){
        const info = document.createElement("span");
        info.style.fontSize = "12px";
        info.style.color = "var(--muted)";
        info.textContent = fileData[it.id].name;
        ex.appendChild(info);
      }
    }
  });
}

function attachEditorHandlers(list){
  document.querySelectorAll(".lbl").forEach(inp=>{
    inp.addEventListener("input", e=>{
      const i = +inp.dataset.i;
      list[i].label = e.target.value;
      scheduleSaveToFirebase(list);
      renderButtons(list);
    });
  });
  document.querySelectorAll(".url").forEach(inp=>{
    inp.addEventListener("input", e=>{
      const i = +inp.dataset.i;
      list[i].url = e.target.value;
      scheduleSaveToFirebase(list);
      renderButtons(list);
    });
  });
  document.querySelectorAll(".icn").forEach(inp=>{
    inp.addEventListener("input", e=>{
      const i = +inp.dataset.i;
      list[i].icon = e.target.value;
      scheduleSaveToFirebase(list);
      renderButtons(list);
    });
  });
  document.querySelectorAll(".typ").forEach(sel=>{
    sel.addEventListener("change", e=>{
      const i = +sel.dataset.i;
      list[i].type = e.target.value;
      scheduleSaveToFirebase(list);
      renderEditor(list);
      renderButtons(list);
    });
  });
  document.querySelectorAll(".up").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = +btn.dataset.i;
      if(i <= 0) return;
      [list[i-1], list[i]] = [list[i], list[i-1]];
      scheduleSaveToFirebase(list);
      renderEditor(list);
      renderButtons(list);
    });
  });
  document.querySelectorAll(".down").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = +btn.dataset.i;
      if(i >= list.length-1) return;
      [list[i], list[i+1]] = [list[i+1], list[i]];
      scheduleSaveToFirebase(list);
      renderEditor(list);
      renderButtons(list);
    });
  });
  document.querySelectorAll(".del").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = +btn.dataset.i;
      const id = list[i].id;
      if(!confirm("Bu butonu silmek istiyor musun?")) return;
      list.splice(i,1);
      if(fileData[id]) delete fileData[id];
      scheduleSaveToFirebase(list);
      renderEditor(list);
      renderButtons(list);
    });
  });
}

// ---------- INIT ----------
document.addEventListener("DOMContentLoaded", async ()=>{
  loadFileData();

  let buttons = loadLocal();
  if(!buttons || !buttons.length){
    buttons = await loadFromFirebase();
  }

  // id / type garanti
  buttons = buttons.map(b=>{
    if(!b.id) b.id = Date.now() + Math.floor(Math.random()*10000);
    if(!b.type) b.type = "link";
    return b;
  });

  saveLocal(buttons);
  renderButtons(buttons);
  renderEditor(buttons);

  document.getElementById("addBtn").addEventListener("click", ()=>{
    buttons.push({
      id: Date.now(),
      label: "Yeni Buton",
      url: "",
      icon: "üîó",
      type: "link",
      mail: ""
    });
    scheduleSaveToFirebase(buttons);
    renderEditor(buttons);
    renderButtons(buttons);
  });

  document.getElementById("forceSaveBtn").addEventListener("click", async ()=>{
    try{
      await DOC_REF.set({buttons});
      saveLocal(buttons);
      alert("Firebase'e kaydedildi.");
    }catch(e){
      alert("Kaydedilirken hata olu≈ütu: " + e.message);
    }
  });

  document.getElementById("resetBtn").addEventListener("click", async ()=>{
    if(!confirm("Bu cihazdaki yerel kaydƒ± sƒ±fƒ±rlamak istiyor musun? (Firebase verisi ayrƒ± kalƒ±r)")) return;
    localStorage.removeItem(LOCAL_KEY);
    localStorage.removeItem(LOCAL_KEY+"_files");
    fileData = {};
    buttons = DEFAULTS.slice();
    scheduleSaveToFirebase(buttons);
    renderEditor(buttons);
    renderButtons(buttons);
  });
});
</script>
</body>
</html>
